This experiment implements a realtime R-peak detector to entrain binocular rivalry stimuli to sytolic and diastolic phases of participants' cardiac cycles, followed by a modified heartbeat discrimination task (to meausure interoceptive accuracy as it pertains to the experimental manipulation in the rivalry task). It uses [labgraph](https://github.com/facebookresearch/labgraph) and [Lab Streaming Layer](https://labstreaminglayer.org) (LSL) for realtime ECG processing. We recorded ECG with a TMSi SAGA, but you can use whatever LSL-compatible hardware you'd like with minimal modification.

1. `environment.yml` contains the conda environment specification used to run the experiment. Before running, create this environment using conda. (We provided the specification with the exact package versions used on our Ubuntu 20.4 machine, since the labgraph depdendencies ended up being somewhat tricky. You might need to use different package versions for your own hardware if you intend to run this code. I apologize in advance that will probably require some troubleshooting on your end.)
2. `graph.py` is the main experiment code. Most of the settings you'd need to change for your own setup (e.g. ECG sampling rate) can be found there, and you can toggle between using real and simulated ECG with a hardcoded variable. If you're using real ECG, the ECG data needs to be streaming over LSL before you run the script.
3. `bidsify.py` converts the log files produced by `graph.py` to [BIDS format](https://bids-specification.readthedocs.io/en/stable/) for posterity. 
